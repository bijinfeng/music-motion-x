import{j as P,a,r as h,b as o,_ as W,F as M}from"./index-12c2092c.js";import{u as Q,S as V,c as q}from"./MediaItemList-9cd646f5.js";import{u as N}from"./useQuery-f35a1b42.js";import{useDispatch as A,useSelector as y}from"./index-7c9c9a2c.js";import{u as b,I as G,M as J}from"./useIsomorphicEffect-25b21b46.js";import{S as K,a as $}from"./Spinner-3ac26fa1.js";import{D as X}from"./Dialog-c5a8fd66.js";import{u as Y}from"./index-8f535541.js";const Z="_play_10b4r_1",ee="_songlist_10b4r_14",te="_contents_10b4r_26",ae="_close_10b4r_33",S={play:Z,songlist:ee,contents:te,close:ae},oe=e=>{if(e){const r=Math.round(e),n=r%60;return`${`${(r-n)/60}`.padStart(2,"0")}:${`${n}`.padStart(2,"00")}`}return"00:00"},re=({playState:e,onClick:r})=>P("div",{onClick:r,children:[e==="loading"&&a(K,{color:"rgb(254, 221, 39)",style:{width:16,height:16}}),(e==="playing"||e==="loaded")&&a("div",{className:" relative w-4 h-4 before:absolute  before:top-0 before:left-0 before:block before:w-[6px] before:h-4 before:bg-secondary before:rounded-[2px] after:top-0 after:left-1 after:block after:w-[6px] after:h-4 after:bg-secondary after:rounded-[2px] after:ml-[10px]"}),["stopped","paused",""].includes(e)&&a("div",{className:S.play})]}),se=({playState:e,handlePlayIconClick:r,hasSong:n,audioCurTime:g})=>{const c=A();return P("div",{className:" flex items-center justify-center",children:[a(re,{playState:e,onClick:r}),a("div",{className:" text-dg font-bold text-lg h-full leading-10 ml-3",onClick:()=>{n&&c(h.actions.setShowPlayModal(!0))},children:oe(g)})]})},ne=o.lazy(()=>W(()=>import("./PlayModal-53daf1c1.js"),["assets/PlayModal-53daf1c1.js","assets/index-12c2092c.js","assets/index-f60ceb86.css","assets/index-7c9c9a2c.js","assets/extends-98964cd2.js","assets/MediaItemList-9cd646f5.js","assets/index-78d1f01c.js","assets/index-8f535541.js","assets/useQuery-f35a1b42.js","assets/inheritsLoose-54b40604.js","assets/useIsomorphicEffect-25b21b46.js","assets/Spinner-3ac26fa1.js","assets/MediaItemList-15d7a71a.css","assets/Dialog-c5a8fd66.js"])),le=()=>{const e=o.useRef(null),[r,n]=o.useState(""),[g,c]=o.useState(!1),d=o.useRef(null),[x,w]=o.useState(0),m=A(),T=Y(),u=y(t=>t.root.isShowPlayModal),l=y(t=>t.root.currentPlaySong.id),D=y(t=>t.root.currentPlaySongList),I=y(t=>t.root.showPlayBar),{data:f,isLoading:_}=N(l?`/api/song/url?id=${l}`:"",()=>l?$.get(`/api/song/url?id=${l}`).then(t=>t.data.data[0]):null,{suspense:!1,refetchOnWindowFocus:!1}),{data:i}=N(l?`/api/song/detail?ids=${l}`:"",()=>l?$.get(`/api/song/detail?ids=${l}`).then(t=>t.data.songs).then(t=>t.map(s=>{const C=s.ar.length?[...s.ar].reverse().reduce((F,H)=>`${H.name} ${F}`,""):"";return{imgUrl:s.al.picUrl?s.al.picUrl.replace(/https?/,"https"):"",title:`${s.name}`,desc:C,artistId:s.ar[0].id,albumId:s.al.id,artistName:C,albumName:s.al.name,type:"song",id:s.id}})[0]):null,{suspense:!1,refetchOnWindowFocus:!1}),L=o.useCallback(()=>{e.current&&w(e.current.duration-e.current.currentTime)},[]),E=o.useCallback(()=>{w(e.current.duration),n("loaded")},[]),O=o.useCallback(()=>{n("playing")},[]),j=o.useCallback(()=>{n("paused")},[]),v=o.useCallback(()=>{r==="paused"||r==="stopped"?e.current.play():(r==="playing"||r==="loaded")&&e.current.pause()},[r]),p=o.useCallback((t,s)=>{s==="prev"?m(h.actions.playPrev()):s==="next"&&m(h.actions.playNext())},[m]),R=o.useCallback(()=>{n("stopped"),p(!1,"next")},[p]),{isShowModal:U,isShowContent:z,onModalOpen:B,onModalClose:k}=Q();return b(()=>{console.log("barRef.current",d.current),d.current&&u?d.current.style.height=window.innerHeight+"px":d.current&&!u&&(d.current.style.height=40+"px",k())},[u]),b(()=>{_&&l&&n("loading")},[_]),b(()=>{e.current&&f?.url?(e.current.src=f.url?.replace?.(/https?/,"https"),e.current.currentTime=0,e.current.play().catch(()=>{c(!0)})):f&&!f?.url&&l&&c(!0)},[f]),b(()=>{m(h.actions.setShowPlayModal(!1))},[T.pathname]),o.useEffect(()=>{"mediaSession"in navigator&&i&&(navigator.mediaSession.metadata=new MediaMetadata({title:i.title??"",artist:i.artistName??"",album:i.albumName??"",artwork:[{src:i.imgUrl??""}]}),navigator.mediaSession.setActionHandler("previoustrack",()=>{p(!0,"prev")}),navigator.mediaSession.setActionHandler("nexttrack",()=>{p(!0,"next")}))},[p,i]),I?P(M,{children:[g&&a(X,{title:"播放出错，请重试",onCancelClick:()=>c(!1),onConfirmClick:()=>{m(h.actions.playSong({})),c(!1)}}),U&&a(G,{isDynamic:!1,children:a(J,{onClick:k,children:P("div",{className:S.songlist,style:{transform:z?"translate3d(0, 0,0)":"translate3d(0, 100%,0)"},children:[a("div",{className:S.contents,children:a(V,{list:D??void 0,placeHolderCount:8,lazyAll:!0,indexedPic:!0,more:!1})}),a("div",{className:S.close,"data-close":"true",children:"×"})]})})}),a("audio",{src:f?.url??"",ref:e,preload:"metadata",onLoadedData:E,onTimeUpdate:L,onPlay:O,onPause:j,onEnded:R,onError:t=>{console.log(t.currentTarget?.error?.code,t.currentTarget?.error?.message)}}),a("div",{className:q("fixed bg-black transition-all overflow-hidden duration-300",{"z-[9999] bottom-0 left-0 rounded-none h-screen w-screen bg-mg will-change-auto p-5":u,"left-4 bottom-5 z-[1000] w-32 h-10 rounded-[500px]":!u}),ref:d,children:u?a(o.Suspense,{children:a(ne,{playState:r,songDetail:i,audioRef:e,audioCurTime:x,handlePlayIconClick:v,onModalOpen:B,onNextOrPrePlay:p})}):a(se,{playState:r,handlePlayIconClick:v,hasSong:!!i,audioCurTime:x})})]}):a(M,{})},ie=le,ye=Object.freeze(Object.defineProperty({__proto__:null,default:ie},Symbol.toStringTag,{value:"Module"}));export{oe as f,ye as i};
